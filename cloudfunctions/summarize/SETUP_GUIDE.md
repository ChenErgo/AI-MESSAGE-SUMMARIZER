# 云函数设置指南

## 问题分析

"查询缓存失败"的错误通常是因为数据库集合不存在或者权限配置问题。

## 解决方案

### 方法一：在云开发控制台手动创建集合（推荐）

1. 打开微信开发者工具
2. 点击顶部菜单【云开发】
3. 进入【数据库】标签
4. 点击【添加集合】按钮
5. 创建以下两个集合：

#### 集合 1: summaries
- 集合名称：`summaries`
- 权限设置：选择【仅创建者可读写】或【所有用户可读，仅创建者可写】
- 索引设置（可选）：
  - 字段名：`openid`
  - 索引类型：普通索引

#### 集合 2: rate_limits
- 集合名称：`rate_limits`
- 权限设置：选择【仅创建者可读写】
- 索引设置（可选）：
  - 字段名：`_id`（默认已有）

### 方法二：让云函数自动创建

代码已经修改为支持自动创建集合，但需要确保：

1. 云函数有数据库写入权限
2. 云开发环境已正确配置

## 验证步骤

1. 重新上传并部署云函数
2. 在小程序中测试消息总结功能
3. 如果成功，会在 `summaries` 集合中看到新记录

## 常见问题

### Q: 还是提示"查询缓存失败"怎么办？

A: 请检查：
1. 云开发环境 ID 是否正确配置
2. 数据库权限是否允许云函数读写
3. 查看云函数日志获取详细错误信息

### Q: 如何查看云函数日志？

A:
1. 在微信开发者工具中
2. 点击【云开发】
3. 进入【云函数】标签
4. 点击 `summarize` 函数
5. 查看【日志】标签

### Q: 数据库权限应该怎么设置？

A: 推荐设置：
- `summaries` 集合：【所有用户可读，仅创建者可写】
- `rate_limits` 集合：【仅创建者可读写】

这样可以确保用户只能看到自己的记录。